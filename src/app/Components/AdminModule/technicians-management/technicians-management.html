<div class="technicians-management" dir="rtl">
  <!-- Header Section -->
  <div class="page-header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1 class="page-title">
            <i class="fas fa-tools"></i>
            إدارة الفنيين
          </h1>
          <p class="page-subtitle">
            عرض وإدارة بيانات الفنيين المسجلين في النظام
          </p>
        </div>
        <div class="col-md-4 text-md-end">
          <button class="btn btn-primary" (click)="loadTechnicians()">
            <i class="fas fa-sync-alt"></i>
            تحديث البيانات
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Search and Filters Section -->
  <div class="container mt-4">
    <div class="search-filters-card">
      <div class="row g-3">
        <div class="col-md-6">
          <div class="search-box">
            <i class="fas fa-search search-icon"></i>
            <input
              type="text"
              class="form-control search-input"
              placeholder="البحث في الاسم أو البريد الإلكتروني أو رقم الهاتف..."
              [(ngModel)]="searchTerm"
              (input)="onSearch()"
            />
          </div>
        </div>
        <div class="col-md-3">
          <select
            class="form-select"
            [(ngModel)]="selectedStatus"
            (change)="onStatusChange()"
          >
            <option value="all">جميع الحالات</option>
            <option value="active">نشط</option>
            <option value="inactive">غير نشط</option>
          </select>
        </div>
        <div class="col-md-3">
          <select
            class="form-select"
            [(ngModel)]="pageSize"
            (change)="onPageSizeChange()"
          >
            <option value="5">5 صفوف</option>
            <option value="10">10 صفوف</option>
            <option value="20">20 صف</option>
            <option value="50">50 صف</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Results Summary -->
    <div class="results-summary mt-3">
      <div class="row align-items-center">
        <div class="col-md-6">
          <p class="results-count">
            تم العثور على <strong>{{ totalItems }}</strong> فني
          </p>
        </div>
        <div class="col-md-6 text-md-end">
          <p class="page-info">
            الصفحة <strong>{{ currentPage }}</strong> من
            <strong>{{ totalPages }}</strong>
          </p>
        </div>
      </div>
    </div>

    <!-- Technicians Table -->
    <div class="table-card mt-4">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>الصورة</th>
              <th>الاسم</th>
              <th>البريد الإلكتروني</th>
              <th>رقم الهاتف</th>
              <th>الحالة</th>
              <th>التقييم</th>
              <th>الإجراءات</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let technician of pagedTechnicians" class="table-row">
              <td>
                <div class="user-avatar">
                  <img
                    [src]="technician.image || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjUwIiBmaWxsPSIjRjVGNUY1Ii8+CjxjaXJjbGUgY3g9IjUwIiBjeT0iMzUiIHI9IjE1IiBmaWxsPSIjQ0NDIi8+CjxwYXRoIGQ9Ik0yMCA3NUMyMCA2NSAzMCA1NSA0MCA1NUg2MEM3MCA1NSA4MCA2NSA4MCA3NVY4NUMyMCA4NSAyMCA3NSAyMCA3NVoiIGZpbGw9IiNDQ0MiLz4KPC9zdmc+'"
                    [alt]="technician.name"
                    class="avatar-img"
                    (error)="onImageError($event)"
                  />
                </div>
              </td>
              <td>
                <div class="user-info">
                  <strong class="user-name">{{ technician.name }}</strong>
                  <small class="user-id">#{{ technician.id }}</small>
                </div>
              </td>
              <td>
                <span class="user-email">{{ technician.email }}</span>
              </td>
              <td>
                <span class="user-phone">{{ technician.phoneNumber || 'غير متوفر' }}</span>
              </td>
              <td>
                <span class="status-badge" [ngClass]="technician.isActivated ? 'status-active' : 'status-inactive'">
                  {{ technician.isActivated ? 'نشط' : 'غير نشط' }}
                </span>
              </td>
              <td>
                <div class="rating-display">
                  <span class="rating-value" [ngClass]="{'low-rating': technician.rate < 3}">
                    {{ technician.rate }}/5
                    <i *ngIf="technician.rate < 3" class="fas fa-exclamation-triangle text-danger ms-1"
                       title="تقييم منخفض - قد يحتاج إلى حظر"></i>
                  </span>
                  <div class="rating-stars">
                    <i *ngFor="let star of [1,2,3,4,5]"
                       class="fas fa-star"
                       [ngClass]="star <= technician.rate ? 'text-warning' : 'text-muted'">
                    </i>
                  </div>
                </div>
              </td>
              <td>
                <div class="action-buttons">
                  <button
                    class="btn btn-sm btn-outline-primary me-2"
                    (click)="viewUserDetails(technician)"
                    title="عرض التفاصيل"
                  >
                    <i class="fas fa-eye"></i>
                    عرض
                  </button>

                  <button
                    class="btn btn-sm btn-outline-info me-2"
                    (click)="viewUserReviews(technician)"
                    title="عرض التقييمات"
                  >
                    <i class="fas fa-star"></i>
                    التقييمات
                  </button>

                  <!-- Block button for all active technicians -->
                  <button
                    *ngIf="technician.isActivated"
                    class="btn btn-sm btn-outline-danger me-2"
                    (click)="blockTechnician(technician)"
                    title="حظر الفني"
                  >
                    <i class="fas fa-ban"></i>
                    حظر
                  </button>

                  <!-- Activate button for blocked technicians -->
                  <button
                    *ngIf="!technician.isActivated"
                    class="btn btn-sm btn-outline-success me-2"
                    (click)="activateTechnician(technician)"
                    title="تفعيل الفني"
                  >
                    <i class="fas fa-check"></i>
                    تفعيل
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Loading State -->
      <div class="loading-state text-center py-5" *ngIf="isLoading">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">جاري التحميل...</span>
        </div>
        <p class="mt-3">جاري تحميل بيانات الفنيين...</p>
      </div>

      <!-- Empty State -->
      <div
        class="empty-state text-center py-5"
        *ngIf="!isLoading && pagedTechnicians.length === 0"
      >
        <i class="fas fa-users fa-3x text-muted mb-3"></i>
        <h4>لا توجد نتائج</h4>
        <p class="text-muted">لم يتم العثور على فنيين يطابقون معايير البحث</p>
      </div>
    </div>

    <!-- Pagination -->
    <div class="pagination-wrapper mt-4" *ngIf="totalPages > 1">
      <nav aria-label="صفحات الفنيين">
        <ul class="pagination justify-content-center">
          <!-- Previous Button -->
          <li class="page-item" [ngClass]="{ disabled: currentPage === 1 }">
            <button
              class="page-link"
              (click)="prevPage()"
              [disabled]="currentPage === 1"
            >
              <i class="fas fa-chevron-right"></i>
              السابق
            </button>
          </li>

          <!-- Page Numbers -->
          <li
            class="page-item"
            *ngFor="let page of pages"
            [ngClass]="{ active: page === currentPage }"
          >
            <button
              class="page-link"
              (click)="setPage(page)"
              [disabled]="page === -1"
            >
              <span *ngIf="page === -1">...</span>
              <span *ngIf="page !== -1">{{ page }}</span>
            </button>
          </li>

          <!-- Next Button -->
          <li
            class="page-item"
            [ngClass]="{ disabled: currentPage === totalPages }"
          >
            <button
              class="page-link"
              (click)="nextPage()"
              [disabled]="currentPage === totalPages"
            >
              التالي
              <i class="fas fa-chevron-left"></i>
            </button>
          </li>
        </ul>
      </nav>
    </div>
  </div>

  <!-- User Details Modal -->
  <div
    class="modal-overlay"
    *ngIf="showUserDetails"
    (click)="closeUserDetails()"
  >
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">
          <i class="fas fa-user-circle"></i>
          تفاصيل الفني
        </h3>
        <button class="btn-close" (click)="closeUserDetails()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body" *ngIf="selectedTechnician">
        <div class="loading-spinner text-center py-4" *ngIf="isLoadingDetails">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">جاري التحميل...</span>
          </div>
          <p class="mt-3">جاري تحميل التفاصيل...</p>
        </div>

        <div class="user-details" *ngIf="!isLoadingDetails">
          <div class="user-profile-section text-center mb-4">
            <div class="user-avatar-large">
              <img
                [src]="selectedTechnician.image || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjUwIiBmaWxsPSIjRjVGNUY1Ii8+CjxjaXJjbGUgY3g9IjUwIiBjeT0iMzUiIHI9IjE1IiBmaWxsPSIjQ0NDIi8+CjxwYXRoIGQ9Ik0yMCA3NUMyMCA2NSAzMCA1NSA0MCA1NUg2MEM3MCA1NSA4MCA2NSA4MCA3NVY4NUMyMCA4NSAyMCA3NSAyMCA3NVoiIGZpbGw9IiNDQ0MiLz4KPC9zdmc+'"
                [alt]="selectedTechnician.name"
                class="avatar-img-large"
                (error)="onImageError($event)"
              />
            </div>
            <h4 class="user-name-large">{{ selectedTechnician.name }}</h4>
            <p class="user-role-large">فني</p>
          </div>

          <div class="user-info-grid">
            <div class="info-item">
              <label>معرف المستخدم:</label>
              <span>#{{ selectedTechnician.id }}</span>
            </div>
            <div class="info-item">
              <label>البريد الإلكتروني:</label>
              <span>{{ selectedTechnician.email }}</span>
            </div>
            <div class="info-item">
              <label>رقم الهاتف:</label>
              <span>{{ selectedTechnician.phoneNumber || "غير متوفر" }}</span>
            </div>
            <div class="info-item">
              <label>الحالة:</label>
              <span
                class="status-badge"
                [ngClass]="selectedTechnician.isActivated ? 'status-active' : 'status-inactive'"
              >
                {{ selectedTechnician.isActivated ? "نشط" : "غير نشط" }}
              </span>
            </div>
          </div>

          <div class="additional-info mt-4">
            <h5>معلومات إضافية</h5>
            <div class="info-grid">
              <div class="info-card">
                <i class="fas fa-star"></i>
                <div>
                  <strong>التقييم</strong>
                  <p>{{ selectedTechnician.rate }}/5</p>
                </div>
              </div>
              <div class="info-card">
                <i class="fas fa-user-check"></i>
                <div>
                  <strong>حالة الحساب</strong>
                  <p>{{ selectedTechnician.isActivated ? 'مفعل' : 'محظور' }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeUserDetails()">
          <i class="fas fa-times"></i>
          إغلاق
        </button>
      </div>
    </div>
  </div>

  <!-- Reviews Modal -->
  <div class="modal-overlay" *ngIf="showReviewsModal" (click)="closeReviewsModal()">
    <div class="modal-content reviews-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">
          <i class="fas fa-star"></i>
          تقييمات {{ selectedUserForReviews?.name }}
        </h3>
        <button class="btn-close" (click)="closeReviewsModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="loading-spinner text-center py-4" *ngIf="isLoadingReviews">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">جاري التحميل...</span>
          </div>
          <p class="mt-3">جاري تحميل التقييمات...</p>
        </div>

        <div class="reviews-content" *ngIf="!isLoadingReviews">
          <!-- User Summary -->
          <div class="user-summary mb-4" *ngIf="selectedUserForReviews">
            <div class="row align-items-center">
              <div class="col-md-3 text-center">
                <div class="user-avatar-medium">
                  <img 
                    [src]="selectedUserForReviews.image || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjUwIiBmaWxsPSIjRjVGNUY1Ii8+CjxjaXJjbGUgY3g9IjUwIiBjeT0iMzUiIHI9IjE1IiBmaWxsPSIjQ0NDIi8+CjxwYXRoIGQ9Ik0yMCA3NUMyMCA2NSAzMCA1NSA0MCA1NUg2MEM3MCA1NSA4MCA2NSA4MCA3NVY4NUMyMCA4NSAyMCA3NSAyMCA3NVoiIGZpbGw9IiNDQ0MiLz4KPC9zdmc+'"
                    [alt]="selectedUserForReviews.name"
                    class="avatar-img-medium"
                    (error)="onImageError($event)"
                  >
                </div>
              </div>
              <div class="col-md-9">
                <h4 class="user-name">{{ selectedUserForReviews.name }}</h4>
                <p class="user-role">فني</p>
                <div class="overall-rating">
                  <span class="rating-value-large">{{ selectedUserForReviews.rate }}/5</span>
                  <div class="rating-stars-large">
                    <i *ngFor="let star of [1,2,3,4,5]" 
                       class="fas fa-star" 
                       [ngClass]="star <= selectedUserForReviews.rate ? 'text-warning' : 'text-muted'">
                    </i>
                  </div>
                  <span class="reviews-count">({{ selectedUserReviews.length }} تقييم)</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Reviews List -->
          <div class="reviews-list" *ngIf="selectedUserReviews.length > 0">
            <h5 class="reviews-section-title">التقييمات</h5>
            <div class="review-item" *ngFor="let review of selectedUserReviews">
              <div class="review-header">
                <div class="reviewer-info">
                  <div class="reviewer-avatar">
                    <i class="fas fa-user-circle"></i>
                  </div>
                  <div class="reviewer-details">
                    <h6 class="reviewer-name">{{ review.reviewerName }}</h6>
                    <span class="review-date">{{ review.date }}</span>
                  </div>
                </div>
                <div class="review-rating">
                  <div class="rating-stars">
                    <i *ngFor="let star of [1,2,3,4,5]" 
                       class="fas fa-star" 
                       [ngClass]="star <= review.rating ? 'text-warning' : 'text-muted'">
                    </i>
                  </div>
                  <span class="rating-value">{{ review.rating }}/5</span>
                  <span class="verified-badge" *ngIf="review.isVerified">
                    <i class="fas fa-check-circle"></i>
                    موثق
                  </span>
                </div>
              </div>
              <div class="review-comment">
                <p>{{ review.comment }}</p>
              </div>
            </div>
          </div>

          <!-- No Reviews -->
          <div class="no-reviews text-center py-4" *ngIf="selectedUserReviews.length === 0">
            <i class="fas fa-star fa-3x text-muted mb-3"></i>
            <h5>لا توجد تقييمات</h5>
            <p class="text-muted">لم يتم تقييم هذا المستخدم بعد</p>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeReviewsModal()">
          <i class="fas fa-times"></i>
          إغلاق
        </button>
      </div>
    </div>
  </div>
</div>
